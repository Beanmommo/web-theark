<script setup lang="ts">
import { useTheme } from 'vuetify/lib/composables/theme.mjs'
import type { Sport } from '../types/sport'
import type { PropType } from 'vue'
import type { Timeslot } from '../types/data'

const props = defineProps({
    sport: {
        type: Object as PropType<Sport>,
        required: true
    }
})

const theme = useTheme()
const router = useRouter()

function clickHandlerBookNow() {
    router.push(`/${props.sport.slug}/venue`)
}

const sportsStore = useSportsStore()
const accentColor = computed(() => {
    const sport = sportsStore.getSportByName(props.sport.name)!
    return theme.themes.value[sport.theme].colors.accent
})

// Calculate dynamic starting rate from timeslots filtered by typeOfSports
const timeslotsStore = useTimeslotsStore()
const { timeslots } = storeToRefs(timeslotsStore)

const locationsStore = useLocationsStore()

const startingRate = computed(() => {
    // Normalize sport slug for comparison
    const normalizedSportSlug = props.sport.slug.toLowerCase()

    // Filter timeslots by typeOfSports matching the sport slug
    // AND check if the location is active
    const sportTimeslots = timeslots.value.filter((timeslot: Timeslot) => {
        const timeslotSport = timeslot.typeOfSports?.toLowerCase() || 'futsal'

        // Check if sport matches
        if (timeslotSport !== normalizedSportSlug) {
            return false
        }

        // Check if location is active
        const location = locationsStore.getLocationByKey(timeslot.locationKey)
        if (!location || !location.active) {
            return false
        }

        return true
    })

    // If no timeslots found, return the hardcoded fallback
    if (sportTimeslots.length === 0) {
        return props.sport.startingRate
    }

    // Get all rates and find the minimum
    const rates = sportTimeslots.map((timeslot: Timeslot) => {
        // Use newRate if it exists and has a startDate, otherwise use rate
        if (timeslot.newRate) {
            return parseInt(timeslot.newRate)
        }
        return parseInt(timeslot.rate)
    })

    return Math.min(...rates)
})

</script>

<template>
    <div class="sportCardItem">
        <template v-if="props.sport">
            <div class="sport__icon__container">
                <VIcon :icon="props.sport.icon" size="64" class="sport__icon" />
            </div>
            <div class="item__content">
                <h3>{{ props.sport.name }}</h3>
                <p><b>From SGD ${{ startingRate }}/hour</b></p>
                <sub><b>{{ props.sport.tag }}</b></sub>
                <div class="buttons__container">
                    <Button @click="clickHandlerBookNow" :color="accentColor">Book Now</Button>
                </div>
            </div>
        </template>
    </div>
</template>

<style lang="scss" scoped>
.sportCardItem {
    display: grid;
    box-shadow: $box-shadow;
    grid-template-columns: 1fr;

    .sport__icon__container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: $margin;
        color: white;
    }

    .item__content {
        display: grid;
        grid-gap: $margin;
        color: white;
        padding: $margin;
        justify-self: center;
        text-align: center;
    }

    .buttons__container {
        margin-top: $margin;
        display: flex;
        justify-content: center;
    }
}
</style>
